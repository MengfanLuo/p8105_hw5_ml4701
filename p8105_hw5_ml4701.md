Homework 5
================
Mengfan Luo
11/20/2021

## Problem 1

### (a) Data loading, description and summary

``` r
homicide_data = read_csv("data/homicide-data.csv",na = c("","Unknown"))
```

    ## Rows: 52179 Columns: 12

    ## -- Column specification --------------------------------------------------------
    ## Delimiter: ","
    ## chr (8): uid, victim_last, victim_first, victim_race, victim_sex, city, stat...
    ## dbl (4): reported_date, victim_age, lat, lon

    ## 
    ## i Use `spec()` to retrieve the full column specification for this data.
    ## i Specify the column types or set `show_col_types = FALSE` to quiet this message.

In the raw data, there are `52179` observations and `12` columns. There
are 23075 missing values, including 60 lying in variable `lat`, 60 in
`lon`, and 2999 in `victim_age`. The variables include 8 character
variables
`uid`,`victim_last`,`victim_first`,`victim_race`,`victim_sex`,`city`,`state`
and `disposition`, and 4 numeric variables `reported_date`,`victim_age`,
`reported_date` and `reported_date`.

`city_state` variable is created to display both city and state
information. Total number of homicides and the number of unsolved
homicides within a city is summarized in the following table. We notice
that “Tulsa,AL” only has 1 total case, and in fact Tulsa is a city in OK
rather than AL, which indicate this might be a error in data entry. We
remove row with `city_state == "Tulsa,AL"` and keep
`city_state == "Tulsa,OK"`.

``` r
homicide_data = homicide_data %>% 
  mutate(city_state = str_c(city,state,sep = ","))

city_summary = homicide_data %>% 
  mutate(
    unsolved = case_when(
      disposition == "Closed by arrest" ~ 0,
      disposition != "Closed by arrest" ~ 1)
    ) %>% 
  group_by(city_state) %>% 
  summarize(city_total = n(),
            unsolved_total = sum(unsolved)) %>% 
  filter(city_state != "Tulsa,AL")
knitr::kable(city_summary)
```

| city\_state       | city\_total | unsolved\_total |
|:------------------|------------:|----------------:|
| Albuquerque,NM    |         378 |             146 |
| Atlanta,GA        |         973 |             373 |
| Baltimore,MD      |        2827 |            1825 |
| Baton Rouge,LA    |         424 |             196 |
| Birmingham,AL     |         800 |             347 |
| Boston,MA         |         614 |             310 |
| Buffalo,NY        |         521 |             319 |
| Charlotte,NC      |         687 |             206 |
| Chicago,IL        |        5535 |            4073 |
| Cincinnati,OH     |         694 |             309 |
| Columbus,OH       |        1084 |             575 |
| Dallas,TX         |        1567 |             754 |
| Denver,CO         |         312 |             169 |
| Detroit,MI        |        2519 |            1482 |
| Durham,NC         |         276 |             101 |
| Fort Worth,TX     |         549 |             255 |
| Fresno,CA         |         487 |             169 |
| Houston,TX        |        2942 |            1493 |
| Indianapolis,IN   |        1322 |             594 |
| Jacksonville,FL   |        1168 |             597 |
| Kansas City,MO    |        1190 |             486 |
| Las Vegas,NV      |        1381 |             572 |
| Long Beach,CA     |         378 |             156 |
| Los Angeles,CA    |        2257 |            1106 |
| Louisville,KY     |         576 |             261 |
| Memphis,TN        |        1514 |             483 |
| Miami,FL          |         744 |             450 |
| Milwaukee,wI      |        1115 |             403 |
| Minneapolis,MN    |         366 |             187 |
| Nashville,TN      |         767 |             278 |
| New Orleans,LA    |        1434 |             930 |
| New York,NY       |         627 |             243 |
| Oakland,CA        |         947 |             508 |
| Oklahoma City,OK  |         672 |             326 |
| Omaha,NE          |         409 |             169 |
| Philadelphia,PA   |        3037 |            1360 |
| Phoenix,AZ        |         914 |             504 |
| Pittsburgh,PA     |         631 |             337 |
| Richmond,VA       |         429 |             113 |
| Sacramento,CA     |         376 |             139 |
| San Antonio,TX    |         833 |             357 |
| San Bernardino,CA |         275 |             170 |
| San Diego,CA      |         461 |             175 |
| San Francisco,CA  |         663 |             336 |
| Savannah,GA       |         246 |             115 |
| St. Louis,MO      |        1677 |             905 |
| Stockton,CA       |         444 |             266 |
| Tampa,FL          |         208 |              95 |
| Tulsa,OK          |         583 |             193 |
| Washington,DC     |        1345 |             589 |

### (b) Proportion of unsolved homicides in Baltimore, MD

For the city of Baltimore, MD, `prop.test` function is used to estimate
the proportion of homicides that are unsolved and the output is saved in
`baltimore_output`.

-   My initial approach:

``` r
baltimore_total = city_summary %>%
  filter(city_state == "Baltimore,MD") %>% 
  pull(city_total)

baltimore_unsolved = city_summary %>%
  filter(city_state == "Baltimore,MD") %>% 
  pull(unsolved_total)


baltimore_output = prop.test(baltimore_unsolved,baltimore_total)


baltimore_estimate = broom::tidy(baltimore_output) %>% 
  pull(estimate)

baltimore_conf.low = broom::tidy(baltimore_output) %>% 
  pull(conf.low)

baltimore_conf.high = broom::tidy(baltimore_output) %>% 
  pull(conf.high)

baltimore_CI = c(baltimore_conf.low,baltimore_conf.high)
```

Using broom::tidy on `baltimore_output` to pull the estimated proportion
and confidence intervals, we get the estimate is 0.6455607 and 95% CI is
\[0.6275625, 0.6631599\].

The proportion of unsolved homicides and the confidence interval for
each cities are retrived using the following pipeline, and is shown in
the following table.

-   Revised method:

<!-- -->

    baltimore_summary= city_summary %>% 
      filter(city_state == "Baltimore,MD")

    baltimore_test = prop.test(
      x = baltimore_summary %>% pull(unsolved_total),
      n = baltimore_summary %>% pull(city_total)
    )

    baltimore_test %>% 
      broom::tidy()

### (c) Proportion of unsolved homicides in all cities

``` r
city_summary %>% 
  filter(city_state != "Tulsa,AL") %>% 
  mutate(output = map2(unsolved_total,city_total,prop.test),
         output = map(output,broom::tidy)) %>% 
  select(city_state,output) %>% 
  unnest(cols = c(output)) %>% 
  mutate(prop_unsolved = round(estimate,4),
    CI = str_c("[",round(conf.low,4),",",round(conf.high,4),"]")) %>% 
  select(city_state,prop_unsolved,CI) %>% 
  knitr::kable()
```

| city\_state       | prop\_unsolved | CI                |
|:------------------|---------------:|:------------------|
| Albuquerque,NM    |         0.3862 | \[0.3373,0.4376\] |
| Atlanta,GA        |         0.3834 | \[0.3528,0.4148\] |
| Baltimore,MD      |         0.6456 | \[0.6276,0.6632\] |
| Baton Rouge,LA    |         0.4623 | \[0.4142,0.511\]  |
| Birmingham,AL     |         0.4338 | \[0.3992,0.469\]  |
| Boston,MA         |         0.5049 | \[0.4646,0.5451\] |
| Buffalo,NY        |         0.6123 | \[0.5688,0.6541\] |
| Charlotte,NC      |         0.2999 | \[0.2661,0.3359\] |
| Chicago,IL        |         0.7359 | \[0.724,0.7474\]  |
| Cincinnati,OH     |         0.4452 | \[0.408,0.4831\]  |
| Columbus,OH       |         0.5304 | \[0.5002,0.5605\] |
| Dallas,TX         |         0.4812 | \[0.4562,0.5062\] |
| Denver,CO         |         0.5417 | \[0.4846,0.5977\] |
| Detroit,MI        |         0.5883 | \[0.5688,0.6076\] |
| Durham,NC         |         0.3659 | \[0.3096,0.4261\] |
| Fort Worth,TX     |         0.4645 | \[0.4223,0.5072\] |
| Fresno,CA         |         0.3470 | \[0.3051,0.3914\] |
| Houston,TX        |         0.5075 | \[0.4892,0.5257\] |
| Indianapolis,IN   |         0.4493 | \[0.4223,0.4766\] |
| Jacksonville,FL   |         0.5111 | \[0.482,0.5401\]  |
| Kansas City,MO    |         0.4084 | \[0.3804,0.437\]  |
| Las Vegas,NV      |         0.4142 | \[0.3881,0.4407\] |
| Long Beach,CA     |         0.4127 | \[0.3629,0.4643\] |
| Los Angeles,CA    |         0.4900 | \[0.4692,0.5109\] |
| Louisville,KY     |         0.4531 | \[0.4121,0.4948\] |
| Memphis,TN        |         0.3190 | \[0.2957,0.3433\] |
| Miami,FL          |         0.6048 | \[0.5686,0.64\]   |
| Milwaukee,wI      |         0.3614 | \[0.3333,0.3905\] |
| Minneapolis,MN    |         0.5109 | \[0.4585,0.5631\] |
| Nashville,TN      |         0.3625 | \[0.3286,0.3977\] |
| New Orleans,LA    |         0.6485 | \[0.6231,0.6732\] |
| New York,NY       |         0.3876 | \[0.3494,0.4271\] |
| Oakland,CA        |         0.5364 | \[0.5041,0.5685\] |
| Oklahoma City,OK  |         0.4851 | \[0.4468,0.5236\] |
| Omaha,NE          |         0.4132 | \[0.3653,0.4627\] |
| Philadelphia,PA   |         0.4478 | \[0.43,0.4657\]   |
| Phoenix,AZ        |         0.5514 | \[0.5185,0.5839\] |
| Pittsburgh,PA     |         0.5341 | \[0.4943,0.5735\] |
| Richmond,VA       |         0.2634 | \[0.2229,0.3083\] |
| Sacramento,CA     |         0.3697 | \[0.3212,0.4209\] |
| San Antonio,TX    |         0.4286 | \[0.3948,0.463\]  |
| San Bernardino,CA |         0.6182 | \[0.5577,0.6753\] |
| San Diego,CA      |         0.3796 | \[0.3354,0.4258\] |
| San Francisco,CA  |         0.5068 | \[0.4681,0.5454\] |
| Savannah,GA       |         0.4675 | \[0.4041,0.5319\] |
| St. Louis,MO      |         0.5397 | \[0.5154,0.5637\] |
| Stockton,CA       |         0.5991 | \[0.5517,0.6447\] |
| Tampa,FL          |         0.4567 | \[0.3881,0.527\]  |
| Tulsa,OK          |         0.3310 | \[0.2932,0.3711\] |
| Washington,DC     |         0.4379 | \[0.4112,0.4649\] |

-   Revised approach

<!-- -->

    prop_test_function = function(homicide_summary){
      homicide_test = prop.test(
        x = homicide_summary %>% pull(unsolved_total),
        n = homicide_summary %>% pull(city_total)
      )
      return(homicide_test)
    }

    results_df = city_summary %>%
      nest(data = city_total:unsolved_total) %>% 
      mutate(
        test_results = map(data,prop_test_function),
        tidy_results = map(test_results,broom::tidy)
      ) %>% 
      select(city_state,tidy_results) %>% 
      unnest(tidy_results) %>% 
      select(city_state,estimate,conf.low, conf.high)
      

### (d) Visualization of estimatied proportion and CIs of unsolved homicides in all cities

Create a plot that shows the estimates and CIs for each city – check out
geom\_errorbar for a way to add error bars based on the upper and lower
limits. Organize cities according to the proportion of unsolved
homicides.

-   My approach

``` r
city_summary %>% 
  mutate(output = map2(unsolved_total,city_total,prop.test),
         output = map(output,broom::tidy)) %>% 
  select(city_state,output) %>% 
  unnest(cols = c(output)) %>% 
  select(city_state,estimate,conf.low,conf.high) %>% 
  mutate(city_state = fct_reorder(city_state,estimate)) %>% 
  ggplot(aes(x = estimate,y = city_state))+
  geom_point()+
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high))+
  labs(
    title = "Estimatied proportion and CIs of unsolved homicides in all cities",
    x = "Estimatied proportion of unsolved homicides",
    y = "City and State"
  )
```

<img src="p8105_hw5_ml4701_files/figure-gfm/unnamed-chunk-5-1.png" width="90%" />

-   Alternative approach

<!-- -->

    city_summary %>% 
      mutate(output = map2(unsolved_total,city_total,prop.test),
             output = map(output,broom::tidy)) %>% 
      select(city_state,output) %>% 
      unnest(cols = c(output)) %>% 
      select(city_state,estimate,conf.low,conf.high) %>% 
      mutate(city_state = fct_reorder(city_state,estimate)) %>% 
      ggplot(aes(x = city_state,y = estimate))+
      geom_point()+
      geom_errorbar(aes(ymin = conf.low, ymax = conf.high))+
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
